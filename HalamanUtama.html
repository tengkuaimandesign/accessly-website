<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACCESSLY - Scheduled Special Room Booking System</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f172a;
      --card:rgba(255,255,255,.86);
      --cardBorder:rgba(255,255,255,.35);
      --shadow:rgba(0,0,0,.18);
      --text:#0f172a;
      --muted:#334155;
      --hero:rgba(255,255,255,.08);
      --heroBorder:rgba(255,255,255,.18);
    }

    /* Dark theme variables */
    html.dark{
      --bg1:#050812;
      --bg2:#0b1022;
      --card:rgba(15,23,42,.75);
      --cardBorder:rgba(148,163,184,.18);
      --shadow:rgba(0,0,0,.40);
      --text:#e5e7eb;
      --muted:#cbd5e1;
      --hero:rgba(255,255,255,.06);
      --heroBorder:rgba(148,163,184,.18);
    }

    body{
      font-family:'Inter',sans-serif;
      min-height:100vh;
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(900px 550px at 90% 25%, rgba(34,197,94,.22), transparent 60%),
        radial-gradient(900px 700px at 55% 95%, rgba(245,158,11,.20), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 45%, var(--bg1) 100%);
    }

    /* subtle noise */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.06;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
    }

    .container-wrapper{
      max-width:60rem;
      margin:0 auto;
      padding:2rem 1rem;
      position:relative;
      z-index:1;
    }

    /* hero header glass */
    .hero{
      background: var(--hero);
      border:1px solid var(--heroBorder);
      border-radius: 1.5rem;
      padding: 1.5rem 1.25rem;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 220px at 50% 0%, rgba(99,102,241,.22), transparent 60%);
      pointer-events:none;
    }

    /* Card style + hover animation */
    .card{
      background: var(--card);
      border:1px solid var(--cardBorder);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius:1.25rem;
      box-shadow: 0 18px 40px var(--shadow);
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
      will-change: transform, box-shadow;
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow: 0 26px 70px rgba(0,0,0,.28);
      border-color: rgba(99,102,241,.35);
    }
    html.dark .card:hover{
      box-shadow: 0 26px 70px rgba(0,0,0,.55);
      border-color: rgba(99,102,241,.45);
    }

    .input-style{
      padding:.75rem 1rem;
      border:1px solid rgba(148,163,184,.75);
      border-radius:.85rem;
      transition: border-color .2s, box-shadow .2s, transform .15s, background .2s, color .2s;
      background: rgba(255,255,255,.86);
      color:#0f172a;
    }
    html.dark .input-style{
      background: rgba(2,6,23,.55);
      border-color: rgba(148,163,184,.28);
      color:#e5e7eb;
    }
    .input-style:focus{
      outline:none;
      border-color:#6366f1;
      box-shadow:0 0 0 4px rgba(99,102,241,.22);
    }

    .gradient-btn{
      background-image: linear-gradient(to right, #4f46e5 0%, #6366f1 55%, #22c55e 120%);
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;
      box-shadow: 0 10px 22px rgba(79,70,229,.28);
    }
    .gradient-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(79,70,229,.38);
      filter: saturate(1.08);
    }

    .gradient-btn-yellow{
      background-image: linear-gradient(to right, #f59e0b 0%, #facc15 100%);
      box-shadow: 0 10px 22px rgba(245,158,11,.26);
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;
    }
    .gradient-btn-yellow:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(245,158,11,.36);
      filter: saturate(1.08);
    }

    .admin-danger-btn{
      background-image: linear-gradient(to right, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 10px 22px rgba(239,68,68,.26);
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;
    }
    .admin-danger-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(239,68,68,.36);
      filter: saturate(1.08);
    }

    /* Smooth view transitions */
    .view{
      opacity:0;
      transform: translateY(8px);
      transition: opacity .35s ease, transform .35s ease;
    }
    .view.is-active{
      opacity:1;
      transform: translateY(0);
    }

    /* Dark-mode friendly text helpers */
    .muted{ color: var(--muted); }
    html.dark .text-gray-800, html.dark .text-gray-900{ color:#e5e7eb !important; }
    html.dark .text-gray-700{ color:#d1d5db !important; }
    html.dark .text-gray-600{ color:#cbd5e1 !important; }
    html.dark .text-gray-500{ color:#94a3b8 !important; }
    html.dark .bg-white{ background-color: rgba(15,23,42,.65) !important; }
    html.dark .bg-gray-50{ background-color: rgba(2,6,23,.55) !important; }
    html.dark .border-gray-200{ border-color: rgba(148,163,184,.22) !important; }
    html.dark .border-gray-300{ border-color: rgba(148,163,184,.28) !important; }
    html.dark .bg-indigo-50{ background-color: rgba(99,102,241,.12) !important; }
    html.dark .bg-yellow-50{ background-color: rgba(245,158,11,.10) !important; }
    html.dark .bg-red-50{ background-color: rgba(239,68,68,.10) !important; }
    html.dark .bg-blue-100{ background-color: rgba(59,130,246,.14) !important; }
    html.dark .bg-green-100{ background-color: rgba(34,197,94,.14) !important; }
    html.dark .bg-red-100{ background-color: rgba(239,68,68,.14) !important; }
    html.dark .bg-gray-100{ background-color: rgba(148,163,184,.12) !important; }
  </style>
</head>

<body class="p-4 sm:p-8">
  <div id="app" class="container-wrapper">
    <!-- Header -->
    <header class="text-center mb-8 hero relative">
      <!-- Dark Mode Toggle -->
      <button id="theme-toggle"
        class="absolute right-4 top-4 sm:right-5 sm:top-5 px-3 py-2 rounded-xl bg-white/15 border border-white/20 text-slate-100 hover:bg-white/20 transition flex items-center gap-2 shadow-lg">
        <i id="theme-icon" data-lucide="moon" class="w-4 h-4"></i>
        <span id="theme-label" class="text-sm font-semibold">Dark</span>
      </button>

      <h1 class="text-5xl sm:text-6xl font-extrabold tracking-tight">
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 via-indigo-500 to-emerald-500">
          ACCESSLY
        </span>
      </h1>
      <p class="text-slate-200/90 mt-2 text-lg">Scheduled Special Room Booking System</p>
      <p class="text-slate-200/70 text-sm mt-1">Demo UI (local storage simulation)</p>
    </header>

    <!-- Status -->
    <div id="status-box" class="card p-4 sm:p-5 rounded-xl mb-8 bg-white border-l-4 border-blue-500 hidden view">
      <p id="status-message" class="font-medium text-gray-700 flex items-center">
        <i data-lucide="info" class="w-5 h-5 mr-3 text-blue-500"></i>
        <span>Processing your request...</span>
      </p>
    </div>

    <!-- Login View -->
    <div id="login-view" class="card p-6 sm:p-10 max-w-md mx-auto view">
      <h2 class="text-3xl font-bold mb-8 text-center text-gray-800 flex items-center justify-center">
        <i data-lucide="lock" class="w-7 h-7 mr-3 text-indigo-500"></i>
        System Login
      </h2>

      <form id="login-form">
        <div class="mb-5">
          <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Lecturer ID</label>
          <input type="text" id="username" value="teacher1" placeholder="Enter your Lecturer ID" class="w-full input-style" required>
        </div>

        <div class="mb-8">
          <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password (6-digit PIN)</label>
          <input type="password" id="password" value="456789" placeholder="Enter your 6-digit PIN" class="w-full input-style" required>
        </div>

        <button type="submit" class="w-full gradient-btn text-white py-3 rounded-xl font-bold text-lg flex items-center justify-center">
          <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
          Sign In
        </button>
      </form>
    </div>

    <!-- Main View -->
    <div id="main-view" class="hidden view">
      <div class="card p-5 mb-8 flex flex-col sm:flex-row justify-between items-center" id="welcome-bar">
        <span class="text-xl font-bold text-gray-800 flex items-center mb-3 sm:mb-0">
          <i data-lucide="user-check" class="w-6 h-6 mr-3 text-green-600"></i>
          Welcome, <span id="welcome-user" class="text-blue-600 ml-1"></span>
        </span>

        <button onclick="logout()" class="text-sm text-red-700 hover:text-white font-medium p-2 rounded-lg transition duration-150 bg-red-100 hover:bg-red-600">
          <i data-lucide="log-out" class="w-4 h-4 inline-block mr-1"></i>
          Sign Out
        </button>
      </div>

      <!-- Teacher Booking View -->
      <div id="teacher-booking-view" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 card p-6 sm:p-8 bg-indigo-50 border-t-4 border-indigo-500 h-fit">
          <h2 class="text-2xl font-bold mb-6 text-indigo-800 flex items-center">
            <i data-lucide="calendar-plus" class="w-6 h-6 mr-3 text-indigo-600"></i>
            Book a Special Room
          </h2>

          <form id="booking-form">
            <div class="mb-4">
              <label for="booking-rack" class="block text-sm font-semibold text-gray-700 mb-2">Select Special Room</label>
              <select id="booking-rack" class="w-full input-style" required></select>
            </div>

            <div class="mb-4">
              <label for="booking-date" class="block text-sm font-semibold text-gray-700 mb-2">Booking Date</label>
              <input type="date" id="booking-date" class="w-full input-style" required>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
              <div>
                <label for="start-time" class="block text-sm font-semibold text-gray-700 mb-2">Start Time</label>
                <input type="time" id="start-time" class="w-full input-style" required>
              </div>
              <div>
                <label for="end-time" class="block text-sm font-semibold text-gray-700 mb-2">End Time</label>
                <input type="time" id="end-time" class="w-full input-style" required>
              </div>
            </div>

            <button type="submit" class="w-full gradient-btn text-white py-3 rounded-xl font-bold flex items-center justify-center">
              <i data-lucide="send" class="w-5 h-5 mr-2"></i>
              Submit Booking
            </button>
          </form>
        </div>

        <div class="lg:col-span-2 card p-6 sm:p-8 bg-white border-t-4 border-red-500">
          <h2 class="text-2xl font-bold mb-6 text-red-800 flex items-center">
            <i data-lucide="zap" class="w-6 h-6 mr-3 text-red-600"></i>
            My Active Booking
          </h2>
          <div id="active-booking-display">
            <p class="text-gray-500 italic text-center py-10">No active booking right now. Please create a new booking.</p>
          </div>
        </div>

        <div class="lg:col-span-3 card p-6 sm:p-8 mt-6 bg-yellow-50 border-t-4 border-yellow-500">
          <h2 class="text-2xl font-bold mb-6 text-yellow-800 flex items-center">
            <i data-lucide="list-ordered" class="w-6 h-6 mr-3 text-yellow-600"></i>
            Other Lecturersâ€™ Booking Schedule
          </h2>
          <div id="schedule-list" class="overflow-x-auto">
            <p class="text-gray-500 text-center py-4">Loading booking schedule...</p>
          </div>
        </div>
      </div>

      <!-- Admin Section -->
      <div id="admin-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-10 hidden">
        <div class="lg:col-span-1 card p-6 sm:p-8 bg-indigo-50 border-t-4 border-indigo-500">
          <h2 class="text-2xl font-bold mb-6 text-indigo-800 flex items-center">
            <i data-lucide="user-plus" class="w-6 h-6 mr-3 text-indigo-600"></i>
            Lecturer Management
          </h2>

          <form id="add-teacher-form">
            <div class="mb-4">
              <label for="new-teacher-id" class="block text-sm font-semibold text-gray-700 mb-2">New Lecturer ID</label>
              <input type="text" id="new-teacher-id" placeholder="e.g. DrSiti" class="w-full input-style" required>
            </div>
            <div class="mb-6">
              <label for="new-teacher-password" class="block text-sm font-semibold text-gray-700 mb-2">PIN / Password (6 digits)</label>
              <input type="password" id="new-teacher-password" placeholder="e.g. 654321" class="w-full input-style" pattern="\d{6}" title="PIN must be 6 digits" required>
            </div>

            <button type="submit" class="w-full gradient-btn text-white py-3 rounded-xl font-bold flex items-center justify-center">
              <i data-lucide="save" class="w-5 h-5 mr-2"></i>
              Add Lecturer
            </button>
          </form>

          <p class="text-xs text-indigo-600 mt-4 text-center">
            Data is stored as a simulation. Telegram notifications are simulated.
          </p>
        </div>

        <div class="lg:col-span-2 card p-6 sm:p-8 bg-white border-t-4 border-green-500">
          <h2 class="text-2xl font-bold mb-6 text-green-800 flex items-center">
            <i data-lucide="list-checks" class="w-6 h-6 mr-3 text-green-600"></i>
            Booking Status & Room Usage
          </h2>

          <div id="bookings-list" class="space-y-4">
            <p class="text-gray-500 text-center py-4">Loading booking status...</p>
          </div>

          <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
              <i data-lucide="lock-open" class="w-5 h-5 mr-2 text-red-500"></i>
              Global Manual Controls (Legacy)
            </h3>

            <div class="grid grid-cols-2 gap-4">
              <button onclick="performAction('/admin/resetlock', 'System lock reset successfully!', 'Failed to reset the lock.')"
                class="bg-yellow-600 text-white py-3 rounded-xl font-bold hover:bg-yellow-700 transition duration-150 shadow-md flex items-center justify-center text-sm">
                <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>
                Reset System Lock
              </button>

              <button onclick="performAction('/admin/clearbookings', 'All bookings have been cleared!', 'Failed to clear bookings.')"
                class="admin-danger-btn text-white py-3 rounded-xl font-bold transition duration-150 flex items-center justify-center text-sm">
                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                Clear All Bookings
              </button>
            </div>
          </div>
        </div>

        <div class="lg:col-span-3 card p-6 sm:p-8 bg-red-50 border-t-4 border-red-500">
          <h2 class="text-2xl font-bold mb-6 text-red-800 flex items-center">
            <i data-lucide="shield-alert" class="w-6 h-6 mr-3 text-red-600"></i>
            Key Rack Manual Control (Solenoid)
          </h2>

          <p class="text-sm text-red-600 mb-6 font-medium">
            Warning! Control each key rack individually only for emergency/maintenance use.
          </p>

          <div id="multi-rack-control" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="confirmation-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm m-4 transform scale-100 transition-transform duration-300 border border-slate-200 card">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 flex items-center">
        <i data-lucide="alert-triangle" class="w-6 h-6 mr-3 text-red-500"></i>
        Confirmation
      </h3>
      <p id="modal-message" class="text-gray-600 mb-6"></p>
      <div class="flex justify-end space-x-3">
        <button onclick="closeConfirmationModal()" class="px-5 py-2 border border-gray-300 rounded-xl text-gray-700 hover:bg-gray-100 transition font-medium">
          Cancel
        </button>
        <button id="modal-action-btn" class="px-5 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition font-bold flex items-center">
          <i data-lucide="check" class="w-4 h-4 mr-1"></i>
          Continue
        </button>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "";
    let userSession = { id: null, isAdmin: false };
    const NUM_KEY_RACKS = 2;
    const RACK_NAMES = { 1: "Special Computer Room", 2: "Special Server Room" };
    let bookingCheckInterval;

    // ---------------------------
    // Dark Mode Toggle (NEW)
    // ---------------------------
    function applyTheme(theme) {
      const isDark = theme === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      localStorage.setItem('theme', theme);

      const icon = document.getElementById('theme-icon');
      const label = document.getElementById('theme-label');

      if (icon) icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
      if (label) label.textContent = isDark ? 'Light' : 'Dark';

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return applyTheme(saved);

      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      const toggleBtn = document.getElementById('theme-toggle');
      toggleBtn?.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');
        applyTheme(isDark ? 'light' : 'dark');
      });
    });

    // ---------------------------
    // Smooth transition helper (NEW)
    // ---------------------------
    function setActiveView(el, isShown) {
      if (!el) return;
      if (isShown) {
        el.classList.remove('hidden');
        requestAnimationFrame(() => el.classList.add('is-active'));
      } else {
        el.classList.remove('is-active');
        setTimeout(() => el.classList.add('hidden'), 220);
      }
    }

    // --- MOCK DATA ---
    function initMockData() {
      if (!localStorage.getItem('teacherAccounts')) {
        const defaultTeachers = [
          { id: 'admin', password: '123456' },
          { id: 'teacher1', password: '456789' }
        ];
        localStorage.setItem('teacherAccounts', JSON.stringify(defaultTeachers));
      }

      if (!localStorage.getItem('keyRackStatus')) {
        const defaultRacks = [];
        for (let i = 1; i <= NUM_KEY_RACKS; i++) {
          defaultRacks.push({
            rackId: i,
            status: 'Key Inside: Ready for Release',
            holder: '',
            room: RACK_NAMES[i]
          });
        }
        localStorage.setItem('keyRackStatus', JSON.stringify(defaultRacks));
      }

      if (!localStorage.getItem('roomBookings')) {
        const now = new Date();
        const todayDate = now.toISOString().split('T')[0];

        const futureTime = new Date(now.getTime() + 15 * 60000);
        const startTimeFuture = `${String(futureTime.getHours()).padStart(2, '0')}:${String(futureTime.getMinutes()).padStart(2, '0')}`;
        const endTimeFuture = `${String(futureTime.getHours() + 1).padStart(2, '0')}:${String(futureTime.getMinutes()).padStart(2, '0')}`;

        const mockBookings = [
          {
            id: crypto.randomUUID(),
            rackId: 2,
            teacherId: 'teacher1',
            roomName: RACK_NAMES[2],
            date: todayDate,
            startTime: '08:00',
            endTime: '09:00',
            status: 'Completed',
            code: '111111'
          },
          {
            id: crypto.randomUUID(),
            rackId: 1,
            teacherId: 'teacher2',
            roomName: RACK_NAMES[1],
            date: todayDate,
            startTime: startTimeFuture,
            endTime: endTimeFuture,
            status: 'Booked',
            code: '998877',
            notification5Sent: false,
            notification10LateSent: false
          }
        ];
        localStorage.setItem('roomBookings', JSON.stringify(mockBookings));
      }
    }
    initMockData();

    document.addEventListener('DOMContentLoaded', () => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      updateView();

      const today = new Date().toISOString().split('T')[0];
      const bookingDateInput = document.getElementById('booking-date');
      if (bookingDateInput) {
        bookingDateInput.min = today;
        bookingDateInput.value = today;
      }

      // Start initial fade-in
      const loginView = document.getElementById('login-view');
      const mainView = document.getElementById('main-view');
      if (userSession.id) setActiveView(mainView, true);
      else setActiveView(loginView, true);
    });

    // --- Utility ---
    function showMessage(message, type = 'info') {
      const statusBox = document.getElementById('status-box');
      const statusMessage = document.getElementById('status-message');

      const icon = type === 'error' ? 'alert-octagon' : (type === 'success' ? 'check-circle' : 'info');
      const colorClass = type === 'error' ? 'bg-red-100 border-red-500' : (type === 'success' ? 'bg-green-100 border-green-500' : 'bg-blue-100 border-blue-500');
      const iconColorClass = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-500' : 'text-blue-500');

      statusMessage.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3 ${iconColorClass}"></i> <span>${message}</span>`;
      statusBox.className = 'card p-4 sm:p-5 rounded-xl mb-8 border-l-4 font-medium view ' + colorClass;
      statusBox.classList.remove('hidden');

      requestAnimationFrame(() => statusBox.classList.add('is-active'));
      if (typeof lucide !== 'undefined') lucide.createIcons();

      setTimeout(() => {
        statusBox.classList.remove('is-active');
        setTimeout(() => statusBox.classList.add('hidden'), 220);
      }, 10000);
    }

    // --- Modal ---
    let modalActionFunction = null;
    function showConfirmationModal(title, message, actionFunction, color = 'red') {
      const modalTitle = document.getElementById('modal-title');
      const modalActionBtn = document.getElementById('modal-action-btn');

      modalTitle.innerHTML = `<i data-lucide="alert-triangle" class="w-6 h-6 mr-3 text-${color}-500"></i> ${title}`;
      document.getElementById('modal-message').textContent = message;
      modalActionFunction = actionFunction;

      modalActionBtn.className = `px-5 py-2 bg-${color}-600 text-white rounded-xl hover:bg-${color}-700 transition font-bold flex items-center`;
      modalActionBtn.onclick = () => {
        if (modalActionFunction) modalActionFunction();
        closeConfirmationModal();
      };

      document.getElementById('confirmation-modal').classList.remove('hidden');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    function closeConfirmationModal() {
      document.getElementById('confirmation-modal').classList.add('hidden');
    }

    // --- Views ---
    function updateView() {
      const loginView = document.getElementById('login-view');
      const mainView = document.getElementById('main-view');
      const adminSection = document.getElementById('admin-section');
      const welcomeBar = document.getElementById('welcome-bar');
      const teacherBookingView = document.getElementById('teacher-booking-view');

      if (userSession.id) {
        setActiveView(loginView, false);
        setActiveView(mainView, true);

        document.getElementById('welcome-user').textContent = userSession.id;
        userSession.isAdmin = userSession.id.toLowerCase().includes('admin');

        if (userSession.isAdmin) {
          adminSection.classList.remove('hidden');
          teacherBookingView.classList.add('hidden');

          welcomeBar.classList.add('bg-red-50');
          welcomeBar.classList.remove('bg-white');

          renderAdminDashboard();
          if (bookingCheckInterval) clearInterval(bookingCheckInterval);
        } else {
          adminSection.classList.add('hidden');
          teacherBookingView.classList.remove('hidden');

          welcomeBar.classList.remove('bg-red-50');
          welcomeBar.classList.add('bg-white');

          renderTeacherBookingView();
          startBookingChecker();
        }
      } else {
        setActiveView(mainView, false);
        setActiveView(loginView, true);
        if (bookingCheckInterval) clearInterval(bookingCheckInterval);
      }

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function logout() {
      userSession.id = null;
      userSession.isAdmin = false;
      showMessage("You have signed out. See you again!", "info");
      updateView();
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      const teacherAccounts = JSON.parse(localStorage.getItem('teacherAccounts'));
      const user = teacherAccounts.find(t => t.id === username && t.password === password);

      if (user) {
        userSession.id = username;
        userSession.isAdmin = username.toLowerCase().includes('admin');
        showMessage(`Login successful! Welcome, ${username}.`, "success");
        updateView();
      } else {
        showMessage("Login failed. Please check your ID and PIN.", "error");
      }
    });

    // --- Booking ---
    function generateRandomCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function renderTeacherBookingView() {
      renderBookingForm();
      renderActiveBooking();
      renderSchedule();
    }

    function renderBookingForm() {
      const select = document.getElementById('booking-rack');
      select.innerHTML = '';
      for (let i = 1; i <= NUM_KEY_RACKS; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${RACK_NAMES[i]} (Rack ${i})`;
        select.appendChild(option);
      }
    }

    document.getElementById('booking-form')?.addEventListener('submit', handleBookingFormSubmit);

    function handleBookingFormSubmit(e) {
      e.preventDefault();

      const rackId = parseInt(document.getElementById('booking-rack').value);
      const date = document.getElementById('booking-date').value;
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;

      const startDateTime = new Date(`${date}T${startTime}:00`);
      const endDateTime = new Date(`${date}T${endTime}:00`);
      const now = new Date();

      if (startDateTime >= endDateTime) return showMessage("Error: End time must be after start time.", "error");
      if (startDateTime <= now) return showMessage("Error: Booking must be made for a future time.", "error");

      let bookings = JSON.parse(localStorage.getItem('roomBookings') || '[]');

      const conflictingBooking = bookings.find(booking => {
        if (booking.rackId !== rackId || booking.date !== date || booking.status === 'Cancelled' || booking.status === 'Completed') return false;
        const existingStart = new Date(`${booking.date}T${booking.startTime}:00`);
        const existingEnd = new Date(`${booking.date}T${booking.endTime}:00`);
        return (startDateTime < existingEnd) && (endDateTime > existingStart);
      });

      if (conflictingBooking) {
        return showMessage(`Error: This room is already booked by ${conflictingBooking.teacherId} from ${conflictingBooking.startTime} to ${conflictingBooking.endTime}.`, "error");
      }

      const newBooking = {
        id: crypto.randomUUID(),
        rackId,
        teacherId: userSession.id,
        roomName: RACK_NAMES[rackId],
        date,
        startTime,
        endTime,
        status: 'Booked',
        code: generateRandomCode(),
        notification5Sent: false,
        notification10LateSent: false
      };

      bookings.push(newBooking);
      localStorage.setItem('roomBookings', JSON.stringify(bookings));

      showMessage(`Booking confirmed for ${RACK_NAMES[rackId]} on ${date} (${startTime} - ${endTime}).`, "success");
      renderActiveBooking();
      renderSchedule();
    }

    let lastNotificationState = {};

    function renderActiveBooking() {
      const displayDiv = document.getElementById('active-booking-display');
      const now = new Date();
      const todayDate = now.toISOString().split('T')[0];
      let bookings = JSON.parse(localStorage.getItem('roomBookings') || '[]');

      let activeBooking = bookings.find(b =>
        b.teacherId === userSession.id &&
        b.date === todayDate &&
        b.status !== 'Completed' &&
        b.status !== 'Cancelled'
      );

      if (!activeBooking) {
        displayDiv.innerHTML = '<p class="text-gray-500 italic text-center py-10">No active/upcoming booking for today. Please create a new booking.</p>';
        return;
      }

      const startDateTime = new Date(`${activeBooking.date}T${activeBooking.startTime}:00`);
      const endDateTime = new Date(`${activeBooking.date}T${activeBooking.endTime}:00`);
      const timeDifferenceToStart = startDateTime.getTime() - now.getTime();
      const timeDifferenceToStop = endDateTime.getTime() - now.getTime();

      const rackStatus = JSON.parse(localStorage.getItem('keyRackStatus')).find(r => r.rackId === activeBooking.rackId);
      const isKeyOut = rackStatus.holder === userSession.id;

      let statusColor = 'text-blue-700 bg-blue-100';
      let actionHtml = '';
      let keyDisplayHtml = '';
      let notificationMessage = '';

      if (timeDifferenceToStart <= 0 && timeDifferenceToStop > 0) {
        activeBooking.status = 'Active';
        statusColor = 'text-green-700 bg-green-100';

        keyDisplayHtml = `
          <p class="text-xl text-gray-700 font-semibold mb-2">Access Code: (Active Now)</p>
          <div class="text-6xl font-extrabold text-green-700 tracking-widest p-4 bg-green-50 rounded-xl border-4 border-green-300 shadow-inner mb-6 text-center">
            ${activeBooking.code}
          </div>
        `;

        if (!isKeyOut && (timeDifferenceToStart < -600000) && !activeBooking.notification10LateSent) {
          notificationMessage = `âš ï¸ [TELEGRAM/SMS] Warning! Your booking for ${activeBooking.roomName} (Code: ${activeBooking.code}) started 10 minutes ago. Please use the key now.`;
          activeBooking.notification10LateSent = true;
        }

        if (isKeyOut) {
          actionHtml = `
            <p class="text-lg font-bold text-gray-700 flex items-center mb-4">
              <i data-lucide="key" class="w-6 h-6 mr-2 text-orange-500"></i>
              You are holding the key. Return it before ${activeBooking.endTime}.
            </p>
            <button onclick="releaseKeyBooking('${activeBooking.id}')" class="gradient-btn-yellow w-full text-white py-3 rounded-xl font-bold flex items-center justify-center">
              <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
              Return Key
            </button>`;
        } else {
          actionHtml = `
            <p class="text-lg font-bold text-red-700 flex items-center mb-4">
              <i data-lucide="shield-alert" class="w-6 h-6 mr-2 text-red-500"></i>
              Press the button below to open the solenoid lock.
            </p>
            <button onclick="useKeyBooking('${activeBooking.id}')" class="gradient-btn w-full text-white py-3 rounded-xl font-bold flex items-center justify-center">
              <i data-lucide="lock-open" class="w-5 h-5 mr-2"></i>
              Use Code & Open Lock
            </button>`;
        }
      } else if (timeDifferenceToStart > 0) {
        statusColor = 'text-blue-700 bg-blue-100';
        keyDisplayHtml = `<p class="text-gray-500 italic text-center py-5">The access code will be shown at ${activeBooking.startTime}.</p>`;

        const minutesToStart = Math.ceil(timeDifferenceToStart / 60000);

        if (minutesToStart <= 5 && !activeBooking.notification5Sent) {
          notificationMessage = `âœ… [TELEGRAM/SMS] Reminder! Your booking for ${activeBooking.roomName} starts in 5 minutes (${activeBooking.startTime}). Code: ${activeBooking.code}.`;
          activeBooking.notification5Sent = true;
        }

        actionHtml = `<p class="text-center text-gray-700 font-medium mt-4">Your booking will be active in about ${minutesToStart} minute(s).</p>`;
      } else {
        activeBooking.status = 'Completed';
        statusColor = 'text-gray-700 bg-gray-100';
        keyDisplayHtml = `<p class="text-gray-500 italic text-center py-5">This booking ended at ${activeBooking.endTime}.</p>`;

        if (isKeyOut) {
          notificationMessage = `ðŸš¨ [ADMIN ALERT] The key for ${activeBooking.roomName} is still held by ${userSession.id} after booking end time. Please return it ASAP.`;
          actionHtml = `
            <p class="text-lg font-bold text-red-700 flex items-center mb-4">
              <i data-lucide="bell" class="w-6 h-6 mr-2 text-red-500"></i>
              TIME OVER. Please return the key ASAP!
            </p>
            <button onclick="releaseKeyBooking('${activeBooking.id}')" class="admin-danger-btn w-full text-white py-3 rounded-xl font-bold flex items-center justify-center">
              <i data-lucide="rotate-ccw" class="w-5 h-5 mr-2"></i>
              Return Key Now
            </button>`;
        } else {
          actionHtml = `<p class="text-center text-gray-700 font-medium mt-4">Completed. You may create a new booking.</p>`;
        }
      }

      localStorage.setItem('roomBookings', JSON.stringify(bookings));

      if (notificationMessage) {
        const key = `${activeBooking.id}-${notificationMessage.substring(0, 10)}`;
        if (!lastNotificationState[key]) {
          showMessage(notificationMessage, (notificationMessage.includes('Warning') || notificationMessage.includes('ALERT')) ? 'error' : 'info');
          lastNotificationState[key] = true;
        }
      }

      displayDiv.innerHTML = `
        <div class="p-4 sm:p-6 rounded-xl border border-dashed border-gray-300 bg-white/70">
          <p class="text-sm font-semibold mb-2 text-gray-500">Your nearest booking:</p>

          <div class="flex items-center justify-between mb-4">
            <span class="text-2xl font-bold text-gray-900">${activeBooking.roomName}</span>
            <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusColor}">${activeBooking.status}</span>
          </div>

          <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-gray-700 text-sm mb-6 border-b pb-4">
            <div class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-indigo-500"></i> ${activeBooking.date}</div>
            <div class="flex items-center"><i data-lucide="clock" class="w-4 h-4 mr-2 text-indigo-500"></i> ${activeBooking.startTime} - ${activeBooking.endTime}</div>
          </div>

          ${keyDisplayHtml}

          <div class="pt-4 border-t border-gray-200">
            ${actionHtml}
          </div>
        </div>
      `;

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function startBookingChecker() {
      if (bookingCheckInterval) clearInterval(bookingCheckInterval);

      renderActiveBooking();
      renderSchedule();

      bookingCheckInterval = setInterval(() => {
        if (userSession.id && !userSession.isAdmin) {
          renderActiveBooking();
          renderSchedule();
        } else {
          clearInterval(bookingCheckInterval);
        }
      }, 5000);
    }

    function renderSchedule() {
      const listDiv = document.getElementById('schedule-list');
      let bookings = JSON.parse(localStorage.getItem('roomBookings') || '[]');
      const now = new Date();

      const schedule = bookings
        .filter(b => b.teacherId !== userSession.id && b.status !== 'Completed' && b.status !== 'Cancelled')
        .sort((a, b) => new Date(`${a.date}T${a.startTime}:00`) - new Date(`${b.date}T${b.startTime}:00`));

      if (schedule.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No active/upcoming bookings from other lecturers.</p>';
        return;
      }

      let html = '<table class="min-w-full divide-y divide-gray-200 rounded-xl shadow-sm overflow-hidden">';
      html += '<thead class="bg-gray-50">';
      html += '<tr>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Special Room</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booked By</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>';
      html += '</tr></thead>';
      html += '<tbody class="bg-white divide-y divide-gray-200">';

      schedule.forEach(b => {
        const startDateTime = new Date(`${b.date}T${b.startTime}:00`);
        const endDateTime = new Date(`${b.date}T${b.endTime}:00`);
        const isCurrent = (startDateTime <= now && endDateTime > now);

        const statusColor = isCurrent ? 'text-red-700 bg-red-100' : 'text-blue-700 bg-blue-100';
        const statusText = isCurrent ? 'ACTIVE' : 'UPCOMING';
        const dateDisplay = new Intl.DateTimeFormat('en-MY', { day: '2-digit', month: 'short', year: 'numeric' }).format(startDateTime);

        html += `
          <tr class="${isCurrent ? 'bg-red-50' : ''}">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dateDisplay}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${b.roomName}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${b.startTime} - ${b.endTime}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${b.teacherId}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                ${statusText}
              </span>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      listDiv.innerHTML = html;
    }

    function useKeyBooking(bookingId) {
      const bookings = JSON.parse(localStorage.getItem('roomBookings') || '[]');
      const booking = bookings.find(b => b.id === bookingId);

      if (!booking) return showMessage("Booking error: Booking not found.", "error");

      showConfirmationModal(
        'Confirm Access Code Usage',
        `Access Code: ${booking.code}. Are you sure you want to unlock ${booking.roomName} (Rack ${booking.rackId})? This will release the physical key.`,
        () => performAction('/book', "Unlocking... Please take the key now.", "Failed to unlock the solenoid.", booking.rackId),
        'blue'
      );
    }

    function releaseKeyBooking(bookingId) {
      const bookings = JSON.parse(localStorage.getItem('roomBookings') || '[]');
      const booking = bookings.find(b => b.id === bookingId);

      showConfirmationModal(
        'Confirm Key Return',
        `Are you sure you want to return and lock ${booking.roomName} (Rack ${booking.rackId})?`,
        () => performAction('/release', "Key returned and locked successfully.", "Failed to lock the solenoid.", booking.rackId),
        'yellow'
      );
    }

    async function performAction(endpoint, successMsg, errorMsg, rackId = null) {
      showMessage("Processing your request...", "info");

      let racks = JSON.parse(localStorage.getItem('keyRackStatus'));

      if (!userSession.id) return showMessage("Session error: Please sign in again.", "error");

      const rackIndex = racks.findIndex(r => r.rackId === (rackId || 1));
      if (rackIndex === -1) return showMessage("Error: Key rack not found.", "error");

      if (endpoint === '/book') {
        racks[rackIndex].status = `Key released by ${userSession.id}`;
        racks[rackIndex].holder = userSession.id;
      } else if (endpoint === '/release') {
        racks[rackIndex].status = 'Key Inside: Ready for Release';
        racks[rackIndex].holder = '';
      } else if (endpoint.includes('solenoid/open')) {
        const rId = parseInt(endpoint.split('/').pop());
        const adminRackIndex = racks.findIndex(r => r.rackId === rId);
        if (adminRackIndex !== -1) {
          racks[adminRackIndex].status = `Key released by ${userSession.id} (ADMIN MANUAL)`;
          racks[adminRackIndex].holder = userSession.id + ' (ADMIN)';
        }
      } else if (endpoint.includes('solenoid/close')) {
        const rId = parseInt(endpoint.split('/').pop());
        const adminRackIndex = racks.findIndex(r => r.rackId === rId);
        if (adminRackIndex !== -1) {
          racks[adminRackIndex].status = 'Key Inside: Ready for Release';
          racks[adminRackIndex].holder = '';
        }
      } else if (endpoint.includes('/admin/resetlock') || endpoint.includes('/admin/clearbookings')) {
        racks = racks.map(r => ({ ...r, status: 'Key Inside: Ready for Release', holder: '' }));
        if (endpoint.includes('/admin/clearbookings')) localStorage.setItem('roomBookings', '[]');
      }

      localStorage.setItem('keyRackStatus', JSON.stringify(racks));
      showMessage(successMsg + " (SIMULATION)", "success");

      if (userSession.isAdmin) renderAdminDashboard();
      else renderActiveBooking();
    }

    document.getElementById('add-teacher-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('new-teacher-id').value.trim();
      const password = document.getElementById('new-teacher-password').value.trim();
      addTeacher(id, password);
    });

    function addTeacher(id, password) {
      if (!id || password.length !== 6) return showMessage("Please enter a valid Lecturer ID and a 6-digit PIN.", "error");

      let teacherAccounts = JSON.parse(localStorage.getItem('teacherAccounts'));
      if (teacherAccounts.find(t => t.id === id)) return showMessage(`Error: Lecturer ID '${id}' already exists.`, "error");

      teacherAccounts.push({ id, password });
      localStorage.setItem('teacherAccounts', JSON.stringify(teacherAccounts));
      showMessage(`Lecturer '${id}' added. PIN: ${password}. Telegram notification simulated.`, "success");
      document.getElementById('add-teacher-form').reset();
    }

    function renderBookings() {
      const racks = JSON.parse(localStorage.getItem('keyRackStatus'));
      const listDiv = document.getElementById('bookings-list');
      listDiv.innerHTML = '';

      let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 rounded-xl shadow-sm overflow-hidden">';
      html += '<thead class="bg-gray-50"><tr>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key Rack</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Physical Status</th>';
      html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Held By</th>';
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

      racks.forEach(rack => {
        const isHeld = !!rack.holder;
        const statusColor = isHeld ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100';
        const statusText = isHeld ? 'RELEASED' : 'KEY INSIDE';
        html += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rack.room} (Rack ${rack.rackId})</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusText}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rack.holder || 'â€” None â€”'}</td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      listDiv.innerHTML = html;
    }

    function renderMultiRackControl() {
      const racks = JSON.parse(localStorage.getItem('keyRackStatus'));
      const controlDiv = document.getElementById('multi-rack-control');
      controlDiv.innerHTML = '';

      racks.forEach(rack => {
        const holderText = rack.holder
          ? `<span class="font-semibold text-red-600">${rack.holder}</span>`
          : `<span class="font-semibold text-green-600">Ready</span>`;

        controlDiv.innerHTML += `
          <div class="p-5 border border-gray-200 rounded-xl bg-white shadow-lg card">
            <h3 class="text-xl font-bold mb-3 text-gray-800 flex items-center">
              <i data-lucide="hard-hat" class="w-5 h-5 mr-2 text-red-700"></i>
              Rack ${rack.rackId} - ${rack.room}
            </h3>
            <p class="text-sm text-gray-600 mb-4">Status: ${rack.status}. Held by: ${holderText}</p>
            <div class="grid grid-cols-2 gap-3">
              <button onclick="adminOpenRack(${rack.rackId})" class="bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center text-sm">
                <i data-lucide="unlock" class="w-4 h-4 mr-1"></i>
                Open (UNLOCK)
              </button>
              <button onclick="showConfirmationModal('Lock Rack ${rack.rackId}', 'Are you SURE you want to LOCK Rack ${rack.rackId}? Make sure the key is returned.', () => adminCloseRack(${rack.rackId}))" class="admin-danger-btn text-white py-3 rounded-lg font-bold transition duration-150 flex items-center justify-center text-sm">
                <i data-lucide="lock" class="w-4 h-4 mr-1"></i>
                Lock (CLOSE)
              </button>
            </div>
          </div>
        `;
      });

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function adminOpenRack(rackId) {
      performAction(`/admin/solenoid/open/${rackId}`, `Manual Control: Rack ${rackId} UNLOCKED.`, `Failed to unlock Rack ${rackId}.`);
    }
    function adminCloseRack(rackId) {
      performAction(`/admin/solenoid/close/${rackId}`, `Manual Control: Rack ${rackId} LOCKED.`, `Failed to lock Rack ${rackId}.`);
    }
    function renderAdminDashboard() {
      renderBookings();
      renderMultiRackControl();
    }
  </script>
</body>
</html>
